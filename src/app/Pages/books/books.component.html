<div class="books-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="bi bi-book"></i>
        My Books
      </h1>
      <p class="page-subtitle">Manage your personal book collection</p>
    </div>
    <button class="add-button" (click)="toggleAddForm()">
      <i class="bi bi-plus-circle"></i>
      {{ showAddForm ? 'Close' : 'Add New Book' }}
    </button>
  </div>

  <!-- Add Book Form -->
  <div class="add-form-section" *ngIf="showAddForm">
    <div class="form-container">
      <h3 class="form-title">
        <i class="bi bi-plus-circle"></i>
        Add New Book
      </h3>
      <form class="book-form">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input class="form-input" type="text" [(ngModel)]="newBookTitle" name="title" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" [(ngModel)]="newBookDescription" name="description" rows="3" required placeholder="Brief description of the book..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Author</label>
            <input class="form-input" type="text" [(ngModel)]="newBookAuthor" name="author" required>
          </div>
          <div class="form-group">
            <label class="form-label">Publication Year</label>
            <input class="form-input" type="number" [(ngModel)]="newBookPublicationYear" name="publicationYear" min="1000" max="2030" placeholder="e.g., 2023">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Genre</label>
            <select class="form-input" [(ngModel)]="newBookGenre" name="genre">
              <option value="">Select Genre</option>
              <option value="Fiction">Fiction</option>
              <option value="Non-Fiction">Non-Fiction</option>
              <option value="Mystery">Mystery</option>
              <option value="Romance">Romance</option>
              <option value="Sci-Fi">Sci-Fi</option>
              <option value="Fantasy">Fantasy</option>
              <option value="Biography">Biography</option>
              <option value="History">History</option>
              <option value="Self-Help">Self-Help</option>
              <option value="Business">Business</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Rating</label>
            <select class="form-input" [(ngModel)]="newBookRating" name="rating">
              <option value="">Select Rating</option>
              <option value="1">1 Star</option>
              <option value="2">2 Stars</option>
              <option value="3">3 Stars</option>
              <option value="4">4 Stars</option>
              <option value="5">5 Stars</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Pages</label>
            <input class="form-input" type="number" [(ngModel)]="newBookPages" name="pages" min="1" placeholder="Number of pages">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" [(ngModel)]="newBookStatus" name="status">
              <option value="">Select Status</option>
              <option value="Want to Read">Want to Read</option>
              <option value="Currently Reading">Currently Reading</option>
              <option value="Read">Read</option>
              <option value="DNF">Did Not Finish</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Tags</label>
          <input class="form-input" type="text" [(ngModel)]="newBookTags" name="tags" placeholder="fiction, mystery, bestseller (comma-separated)">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" [(ngModel)]="newBookNotes" name="notes" rows="2" placeholder="Personal notes, quotes, or thoughts about this book..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="toggleAddForm()">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="addBookInline()">Add Book</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading books...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-state">
    <i class="bi bi-exclamation-triangle"></i>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="loadUserBooks()">Try Again</button>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && !error && books.length === 0" class="empty-state">
    <i class="bi bi-book"></i>
    <h3>No books found</h3>
    <p>Start building your personal library!</p>
  </div>

  <!-- Books Grid -->
  <div *ngIf="!isLoading && !error && books.length > 0" class="books-grid" [class.rows-layout]="currentLayout === 'rows'">
    <div *ngFor="let book of books" 
         class="book-card" 
         [class.expanded]="isBookExpanded(book.id)"
         (click)="toggleBookExpansion(book.id)">
      <div class="book-header">
        <div class="book-title-section">
          <h3 class="book-title">{{ book.title }}</h3>
          <div class="book-meta">
            <span class="book-type">Book</span>
            <span *ngIf="book.genre" class="book-genre">{{ book.genre }}</span>
          </div>
        </div>
        <div class="book-actions" (click)="$event.stopPropagation()">
          <button class="action-button expand" 
                  [title]="isBookExpanded(book.id) ? 'Collapse' : 'Expand'"
                  (click)="toggleBookExpansion(book.id, $event)">
            <i class="bi" [class.bi-chevron-down]="!isBookExpanded(book.id)" [class.bi-chevron-up]="isBookExpanded(book.id)"></i>
          </button>
          <button class="action-button edit" (click)="editBook(book.id)" title="Edit">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="action-button delete" (click)="deleteBook(book.id)" title="Delete">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>

      <div class="book-content">
        <div class="book-author">
          <i class="bi bi-person"></i>
          <span>{{ book.author }}</span>
        </div>
        
        <div class="book-description">
          <p [class.truncated]="!isBookExpanded(book.id)">
            {{ isBookExpanded(book.id) ? book.description : truncateText(book.description) }}
          </p>
        </div>

        <!-- Expanded Content -->
        <div class="book-details" *ngIf="isBookExpanded(book.id)">
          <div class="detail-row" *ngIf="book.publicationYear">
            <i class="bi bi-calendar"></i>
            <span class="detail-label">Year:</span>
            <span class="detail-value">{{ book.publicationYear }}</span>
          </div>
          <div class="detail-row" *ngIf="book.rating">
            <i class="bi bi-star"></i>
            <span class="detail-label">Rating:</span>
            <span class="detail-value">{{ book.rating }} Star{{ book.rating !== '1' ? 's' : '' }}</span>
          </div>
          <div class="detail-row" *ngIf="book.pages">
            <i class="bi bi-book"></i>
            <span class="detail-label">Pages:</span>
            <span class="detail-value">{{ book.pages }}</span>
          </div>
          <div class="detail-row" *ngIf="book.status">
            <i class="bi bi-check-circle"></i>
            <span class="detail-label">Status:</span>
            <span class="detail-value">{{ book.status }}</span>
          </div>
          <div class="detail-row" *ngIf="book.tags && book.tags.length > 0">
            <i class="bi bi-tags"></i>
            <span class="detail-label">Tags:</span>
            <div class="tags-container">
              <span *ngFor="let tag of book.tags" class="tag">{{ tag }}</span>
            </div>
          </div>
          <div class="detail-row" *ngIf="book.notes">
            <i class="bi bi-sticky"></i>
            <div class="notes-content">
              <span class="detail-label">Notes:</span>
              <p class="detail-value notes">{{ book.notes }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Count -->
  <div *ngIf="!isLoading && !error && books.length > 0" class="results-info">
    <p>Showing {{ books.length }} book{{ books.length === 1 ? '' : 's' }}</p>
  </div>

  <!-- Edit Modal -->
  <div id="modal" class="modal" [style.display]="modalVisible ? 'flex' : 'none'">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Book</h3>
        <button class="close-modal" (click)="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input class="form-input" type="text" [(ngModel)]="editTitle" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" [(ngModel)]="editDescription" rows="3" required placeholder="Brief description of the book..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Author</label>
            <input class="form-input" type="text" [(ngModel)]="editAuthor" required>
          </div>
          <div class="form-group">
            <label class="form-label">Publication Year</label>
            <input class="form-input" type="number" [(ngModel)]="editPublicationYear" min="1000" max="2030" placeholder="e.g., 2023">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Genre</label>
            <select class="form-input" [(ngModel)]="editGenre">
              <option value="">Select Genre</option>
              <option value="Fiction">Fiction</option>
              <option value="Non-Fiction">Non-Fiction</option>
              <option value="Mystery">Mystery</option>
              <option value="Romance">Romance</option>
              <option value="Sci-Fi">Sci-Fi</option>
              <option value="Fantasy">Fantasy</option>
              <option value="Biography">Biography</option>
              <option value="History">History</option>
              <option value="Self-Help">Self-Help</option>
              <option value="Business">Business</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Rating</label>
            <select class="form-input" [(ngModel)]="editRating">
              <option value="">Select Rating</option>
              <option value="1">1 Star</option>
              <option value="2">2 Stars</option>
              <option value="3">3 Stars</option>
              <option value="4">4 Stars</option>
              <option value="5">5 Stars</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Pages</label>
            <input class="form-input" type="number" [(ngModel)]="editPages" min="1" placeholder="Number of pages">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" [(ngModel)]="editStatus">
              <option value="">Select Status</option>
              <option value="Want to Read">Want to Read</option>
              <option value="Currently Reading">Currently Reading</option>
              <option value="Read">Read</option>
              <option value="DNF">Did Not Finish</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Tags</label>
          <input class="form-input" type="text" [(ngModel)]="editTags" placeholder="fiction, mystery, bestseller (comma-separated)">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" [(ngModel)]="editNotes" rows="2" placeholder="Personal notes, quotes, or thoughts about this book..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveEditedBook()">Save Changes</button>
      </div>
    </div>
  </div>
</div>